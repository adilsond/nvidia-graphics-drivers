From 48d73e63b51aec8e9137e4c3274c5d5366d9d1d3 Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Sun, 19 Sep 2021 15:24:53 +0200
Subject: [PATCH 2/2] backport set_current_state changes from 470.63.01

---
 nvidia/nvlink_linux.c | 2 +-
 nvidia/os-interface.c | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/nvidia/nvlink_linux.c b/nvidia/nvlink_linux.c
index 872bc90..ba57b86 100644
--- a/nvidia/nvlink_linux.c
+++ b/nvidia/nvlink_linux.c
@@ -597,7 +597,7 @@ void NVLINK_API_CALL nvlink_sleep(unsigned int ms)
         // the requested timeout has expired, loop until less
         // than a jiffie of the desired delay remains.
         //
-        current->state = TASK_INTERRUPTIBLE;
+        set_current_state(TASK_INTERRUPTIBLE);
         do
         {
             schedule_timeout(jiffies);
diff --git a/nvidia/os-interface.c b/nvidia/os-interface.c
index 3603a5a..262171f 100644
--- a/nvidia/os-interface.c
+++ b/nvidia/os-interface.c
@@ -580,7 +580,7 @@ NV_STATUS NV_API_CALL os_delay(NvU32 MilliSeconds)
         // the requested timeout has expired, loop until less
         // than a jiffie of the desired delay remains.
         //
-        current->state = TASK_INTERRUPTIBLE;
+        set_current_state(TASK_INTERRUPTIBLE);
         do
         {
             schedule_timeout(jiffies);
-- 
2.20.1

