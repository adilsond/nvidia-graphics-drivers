From 10f6a0f3ee40d5e25490a07e1cb01d0aa6b0167c Mon Sep 17 00:00:00 2001
From: Andreas Beckmann <anbe@debian.org>
Date: Wed, 22 Sep 2021 08:49:14 +0200
Subject: [PATCH 1/2] backport error on unknown conftests

for easier backporting of future conftest.sh changes
---
 conftest.sh          | 11 +++++++++++
 nvidia/nvidia.Kbuild |  4 ++--
 2 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/conftest.sh b/conftest.sh
index 1d142a1..e5f9146 100755
--- a/conftest.sh
+++ b/conftest.sh
@@ -4610,6 +4610,17 @@ compile_test() {
             compile_check_conftest "$CODE" "NV_RESERVATION_OBJECT_RESERVE_SHARED_HAS_NUM_FENCES_ARG" "" "types"
         ;;
 
+        # When adding a new conftest entry, please use the correct format for
+        # specifying the relevant upstream Linux kernel commit.
+        #
+        # <function> was added|removed|etc by commit <sha> ("<commit message")
+        # in <kernel-version> (<commit date>).
+
+        *)
+            # Unknown test name given
+            echo "Error: unknown conftest '$1' requested" >&2
+            exit 1
+        ;;
     esac
 }
 
diff --git a/nvidia/nvidia.Kbuild b/nvidia/nvidia.Kbuild
index e1596ce..2e8048f 100644
--- a/nvidia/nvidia.Kbuild
+++ b/nvidia/nvidia.Kbuild
@@ -105,7 +105,7 @@ NV_OBJECTS_DEPEND_ON_CONFTEST += $(NVIDIA_OBJECTS)
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += remap_pfn_range
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += hash__remap_4k_pfn
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += follow_pfn
-NV_CONFTEST_FUNCTION_COMPILE_TESTS += vmap
+#NV_CONFTEST_FUNCTION_COMPILE_TESTS += vmap
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += set_pages_uc
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += list_is_first
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += set_memory_uc
@@ -127,7 +127,7 @@ NV_CONFTEST_FUNCTION_COMPILE_TESTS += acpi_walk_namespace
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += pci_domain_nr
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += dma_mapping_error
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += sg_alloc_table
-NV_CONFTEST_FUNCTION_COMPILE_TESTS += sg_init_table
+#NV_CONFTEST_FUNCTION_COMPILE_TESTS += sg_init_table
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += pci_get_domain_bus_and_slot
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += get_num_physpages
 NV_CONFTEST_FUNCTION_COMPILE_TESTS += efi_enabled
-- 
2.20.1

